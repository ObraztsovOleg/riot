#include <stdlib.h>
#include <string.h>
#include <stdio.h>

#include "shell.h"
#include "thread.h"

#include "amx.h"

//static char amx_thread_stack[4096];

static const unsigned char program[] = {
		  0x68, 0x00, 0x00, 0x00, 0xe0, 0xf1, 0x0b, 0x0b, 0x04, 0x00, 0x08, 0x00,
		  0x50, 0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x00,
		  0x68, 0x08, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00,
		  0x3c, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00,
		  0x3c, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00, 0x00,
		  0x03, 0x00, 0x00, 0x40, 0x46, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x44, 0x65,
		  0x63, 0x69, 0x6d, 0x61, 0x6c, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00,
		  0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
		  0x2a, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00
};

/*static void *amx_thread(void *arg) {
	(void) arg;

	AMX amx;
	memset(&amx, 0, sizeof(amx));

	int res = amx_Init(&amx, &program);
	if (res) {
		printf("amx error: %d\n", res);
		while(1);
	}

	int ret = 0;
	res = amx_Exec(&amx, (cell *) &ret, AMX_EXEC_MAIN);
	if (res) {
		printf("amx error: %d\n", res);
		while(1);
	}

	printf("amx returned value: %d\n", ret);

	while (1);

	return NULL;
}*/

int main(void)
{
	//thread_create(amx_thread_stack, sizeof(amx_thread_stack), THREAD_PRIORITY_MAIN - 1, 0, amx_thread, NULL, "amx thread");

	AMX amx;
	memset(&amx, 0, sizeof(amx));

	int res = amx_Init(&amx, &program);
	if (res) {
		printf("amx error: %d\n", res);
		while(1);
	}

	int ret = 0;
	res = amx_Exec(&amx, (cell *) &ret, AMX_EXEC_MAIN);
	if (res) {
		printf("amx error: %d\n", res);
		while(1);
	}

	printf("amx returned value: %d\n", ret);

    char line_buf[SHELL_DEFAULT_BUFSIZE];
    shell_run(NULL, line_buf, SHELL_DEFAULT_BUFSIZE);

    return 0;
}
